= Function Calling

You can register custom Java functions with the `OpenAiChatClient` and have the OpenAI model intelligently choose to output a JSON object containing arguments to call one or many of the registered functions.
This allows you to connect the LLM capabilities with external tools and APIs.
The OpenAI models are trained to detect when a function should to be called and to respond with JSON that adheres to the function signature.

The OpenAI API does not call the function directly; instead, the model generates JSON that you can use to call the function in your code and return the result back to the model to complete the conversation.

Spring AI provides flexible and user-friendly ways to register and call custom functions.
In general the custom functions need to provide a function `name`, function `description` that helps the model to understand when to call the function, and the function call `signature` (as JSON schema) to let the model know what arguments the function expects.

Then you can implement a function that takes the function call arguments from the model interacts with the external, 3rd party, services and returns the result back to the model.

Spring AI offers a generic link:https://github.com/spring-projects/spring-ai/blob/main/spring-ai-core/src/main/java/org/springframework/ai/model/function/FunctionCallback.java[FunctionCallback.java] interface and the companion link:https://github.com/spring-projects/spring-ai/blob/main/spring-ai-core/src/main/java/org/springframework/ai/model/function/FunctionCallbackWrapper.java[FunctionCallbackWrapper.java] utility class to simplify the implementation and registration of Java callback functions.

Additionally the Auto-Configuration provides a way to auto-register any Function<I, O> beans definition as function calling candidates in the `ChatClient`.

== Quick Start

Lets create a chatbot that answer questions by calling external tools.
For example lets register a custom function that takes a location and returns the current weather in that location.
Question such as "What’s the weather like in Boston?" should trigger the model to call the function providing the location as an argument.
The function uses some weather service API and returns the weather response back to the model to complete the conversation.

Let the `MockWeatherService.java` represent the 3-rd party weather service API:

[source,java]
----
public class MockWeatherService implements Function<Request, Response> {

	public enum Unit { C, F }
	public record Request(String location, Unit unit) {}
	public record Response(double temp, Unit unit) {}

	public Response apply(Request request) {
		return new Response("30", Unit.C);
	}
}
----

=== Registering Functions as Beans

With the link:../openai-chat.html#_auto_configuration[OpenAiChatClient Auto-Configuration] you have multiple ways to register custom functions as beans in the Spring context.

==== FunctionCallback Wrapper

One way to register a function is to create `FunctionCallbackWrapper` wrapper like this:

[source,java]
----
@Configuration
static class Config {

	@Bean
	public FunctionCallback weatherFunctionInfo() {

		return new FunctionCallbackWrapper<>("CurrentWeather", // (1) function name
				"Get the weather in location", // (2) function description
				(response) -> "" + response.temp() + response.unit(), // (3) Response Converter
				new MockWeatherService()); // function code
	}
	...
}
----

It wraps the 3rd party, `MockWeatherService` function and registers it as a `CurrentWeather` function with the `OpenAiChatClient`.
It also provides a description (2) and an optional response converter (3) to convert the response into a text as expected by the model.

NOTE: The `FunctionCallbackWrapper` internally resolves the function call signature based on the `MockWeatherService.Request` class.

To let the model know and call your `CurrentWeather` function you need to enable it in your prompt requests:

[source,java]
----
OpenAiChatClient chatClient = ...

UserMessage userMessage = new UserMessage("What's the weather like in San Francisco, Tokyo, and Paris?");

ChatResponse response = chatClient.call(new Prompt(List.of(userMessage),
		OpenAiChatOptions.builder().withEnabledFunction("CurrentWeather").build())); // (1) Enable the function

logger.info("Response: {}", response);
----

NOTE: You can can have multiple functions registered in your `ChatClient` but only those enabled in the prompt request will be considered for the function calling.

Above user question will trigger 3 calls to `CurrentWeather` function (one for each city) and the final response will be something like this:

----
Here is the current weather for the requested cities:
- San Francisco, CA: 30.0°C
- Tokyo, Japan: 10.0°C
- Paris, France: 15.0°C
----

The link:https://github.com/spring-projects/spring-ai/blob/main/spring-ai-spring-boot-autoconfigure/src/test/java/org/springframework/ai/autoconfigure/openai/tool/FunctionCallbackWrapperIT.java[FunctionCallbackWrapperIT.java] test demo this approach.


==== Plain Java Functions

Instead of creating a `FunctionCallbackWrapper` wrapper you can register any plain `java.util.Function<I,O>` as a function calling candidate in the `ChatClient`:

[source,java]
----
@Configuration
static class Config {

	@Bean("CurrentWeather1") // (1) use the bean alias as function name.
	@Description("Get the weather in location") // (2) function description
	public Function<MockWeatherService.Request, MockWeatherService.Response> weatherFunction1() {
		MockWeatherService weatherService = new MockWeatherService();
		return (weatherService::apply);
	}
	...
}
----

The `@Description` annotation is optional and provides a function description (2) that helps the model to understand when to call the function.

Another options is to use the `@JacksonDescription` annotation on the `MockWeatherService.Request` to provide the function description:

[source,java]
----

@Configuration
static class Config {

	@Bean
	public Function<Request, Response> currentWeather3() { // (1) bean name as function name.
		MockWeatherService weatherService = new MockWeatherService();
		return (weatherService::apply);
	}
	...
}

@JsonClassDescription("Get the weather in location") // (2) function description
public record Request(String location, Unit unit) {}
----

The link:https://github.com/spring-projects/spring-ai/blob/main/spring-ai-spring-boot-autoconfigure/src/test/java/org/springframework/ai/autoconfigure/openai/tool/FunctionCallbackWithPlainFunctionBeanIT.java[FunctionCallbackWithPlainFunctionBeanIT.java] test demo this approach.

=== Register/Call Functions with Prompt Options

In addition to the auto-configuration you can register callback functions, dynamically, with your Prompt requests:

[source,java]
----
OpenAiChatClient chatClient = ...

UserMessage userMessage = new UserMessage("What's the weather like in San Francisco, Tokyo, and Paris?");

var promptOptions = OpenAiChatOptions.builder()
	.withFunctionCallbacks(List.of(new DefaultToolFunctionCallback<>(
		"CurrentWeather", // name
		"Get the weather in location", // function description
		new MockWeatherService()))) // function code
	.build();

ChatResponse response = chatClient.call(new Prompt(List.of(userMessage), promptOptions));
----

NOTE: The in-prompt registered functions are enabled by default for the duration of this request.

This approach allows to dynamically chose different functions to be called based on the user input.

The https://github.com/spring-projects/spring-ai/blob/main/spring-ai-spring-boot-autoconfigure/src/test/java/org/springframework/ai/autoconfigure/openai/tool/FunctionCallbackInPromptIT.java[FunctionCallbackInPromptIT.java] integration test provides a complete example of how to register a function with the `OpenAiChatClient` and use it in a prompt request.

=== Register Functions with Default Options

You can programmatically register functions with the `OpenAiChatClient` using the `OpenAiChatOptions#withFunctionCallbacks`:

[source,java]
----

OpenAiApi openaiApi = new OpenAiApi(apiKey);

var defaultOptions = OpenAiChatOptions.builder()
	.withFunctionCallbacks(List.of(new DefaultToolFunctionCallback<>(
		"CurrentWeather", // name
		"Get the weather in location", // function description
		new MockWeatherService()))) // function code
	.build();

OpenAiChatClient chatClient = new OpenAiChatClient(openaiApi, defaultOptions);

UserMessage userMessage = new UserMessage("What's the weather like in San Francisco, Tokyo, and Paris?");

ChatResponse response = chatClient.call(new Prompt(List.of(userMessage),
		OpenAiChatOptions.builder().withEnabledFunction("CurrentWeather").build())); // Enable the function
----

NOTE: Functions are registered when OpenAiChatClient is created, by you must enable in the Prompt the functions to be used in the request.


=== Function Calling Flow

The following diagram illustrates the flow of the OpenAiChatClient Function Calling:

image:openai-chatclient-function-call.png[Chat Client Function Calling Flow]

== Appendices:

=== OpenAI API Function Calling Flow

The following diagram illustrates the flow of the OpenAI API https://platform.openai.com/docs/guides/function-calling[Function Calling]:

image:openai-function-calling-flow.png[OpenAI API Function Calling Flow]

The link:https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-openai/src/test/java/org/springframework/ai/openai/chat/api/tool/OpenAiApiToolFunctionCallIT.java[OpenAiApiToolFunctionCallIT.java] provides a complete example on how to use the OpenAI API function calling.
It is based on the https://platform.openai.com/docs/guides/function-calling/parallel-function-calling[OpenAI Function Calling tutorial].
